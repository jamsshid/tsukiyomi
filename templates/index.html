<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tsukiyomi Menu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        body.dark-mode { background-color: #1a1a1a; color: white; }
        .product-card { border-radius: 15px; overflow: hidden; margin-bottom: 15px; border: 1px solid #ddd; transition: 0.3s; }
        .dark-mode .product-card { border: 1px solid #444; background-color: #252525 !important; }
        .main-btn { position: fixed; bottom: 20px; left: 10%; width: 80%; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .img-container { width: 80px; height: 80px; object-fit: cover; }
    </style>
</head>
<body class="dark-mode" id="body">
    <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 id="title">Tsukiyomi Menu</h4>
            <div>
                <button onclick="toggleLang()" class="btn btn-outline-info btn-sm" id="langBtn">RU</button>
                <button onclick="toggleTheme()" class="btn btn-outline-warning btn-sm">‚òÄÔ∏è/üåô</button>
            </div>
        </div>

        <div id="product-list">
            {% for p in products %}
            <div class="product-card p-2 d-flex align-items-center bg-dark">
                <img src="{{ p.image.url }}" class="img-container rounded me-3" alt="product">
                <div class="flex-grow-1">
                    <h6 class="m-0 name-uz">{{ p.name_uz }}</h6>
                    <h6 class="m-0 name-ru d-none">{{ p.name_ru }}</h6>
                    <span class="text-success fw-bold">{{ p.price }} so'm</span>
                </div>
                <div class="d-flex align-items-center">
                    <button onclick="changeQty('{{p.id}}', '{{p.name_uz}}', '{{p.price}}', -1)" class="btn btn-sm btn-danger">-</button>
                    <b class="mx-2" id="qty-{{p.id}}">0</b>
                    <button onclick="changeQty('{{p.id}}', '{{p.name_uz}}', '{{p.price}}', 1)" class="btn btn-sm btn-success">+</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <button id="orderBtn" class="btn btn-primary main-btn d-none" onclick="sendOrder()">
            Buyurtmani tasdiqlash
        </button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand(); // Ilovani to'liq ekranga yoyish

        let cart = {};
        let lang = 'uz';

        function toggleTheme() {
            document.getElementById('body').classList.toggle('dark-mode');
        }

        function toggleLang() {
            lang = lang === 'uz' ? 'ru' : 'uz';
            document.querySelectorAll('.name-uz').forEach(el => el.classList.toggle('d-none'));
            document.querySelectorAll('.name-ru').forEach(el => el.classList.toggle('d-none'));
            document.getElementById('langBtn').innerText = lang === 'uz' ? 'RU' : 'UZ';
            
            // Tugma matnini ham o'zgartirish
            const orderBtn = document.getElementById('orderBtn');
            orderBtn.innerText = lang === 'uz' ? 'Buyurtmani tasdiqlash' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑';
        }

        function changeQty(id, name, price, delta) { 
            let el = document.getElementById('qty-' + id);
            let current = parseInt(el.innerText) || 0;
            let next = Math.max(0, current + delta);
            el.innerText = next;
            
            if (next > 0) {
                cart[id] = {
                    name: name,
                    price: price,
                    qty: next
                };
            } else {
                delete cart[id];
            }

            // Savatda mahsulot bo'lsa tugmani ko'rsatish
            const orderBtn = document.getElementById('orderBtn');
            if (Object.keys(cart).length > 0) {
                orderBtn.classList.remove('d-none');
            } else {
                orderBtn.classList.add('d-none');
            }
        }

        function sendOrder() {
            // Telegram botga ma'lumot yuborish
            if (Object.keys(cart).length > 0) {
                tg.sendData(JSON.stringify(cart));
                tg.close();
            }
        }
    </script>
</body>
</html>